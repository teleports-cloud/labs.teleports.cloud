version: 2.1

orbs:
  node: circleci/node@5.2.0
  python: circleci/python@2.1.1

# Define contexts for environment variables
# Set these in CircleCI Project Settings > Contexts:
# - deployment-secrets: VERCEL_TOKEN, VERCEL_PROJECT_ID, VERCEL_TEAM_ID, RENDER_API_KEY, RENDER_DEPLOY_HOOK_ID

jobs:
  # Validate configuration using CircleCI CLI
  validate_config:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Install CircleCI CLI
          command: |
            curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/main/install.sh | bash
      - run:
          name: Validate CircleCI Config
          command: |
            circleci config validate

  # Build and test frontend
  build_frontend:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - pnpm-packages-{{ checksum "apps/web/package.json" }}
            - pnpm-packages-
      - run:
          name: Install pnpm
          command: npm install -g pnpm@8
      - run:
          name: Install Dependencies
          command: pnpm install --frozen-lockfile
          working_directory: apps/web
      - save_cache:
          key: pnpm-packages-{{ checksum "apps/web/package.json" }}
          paths:
            - ~/.pnpm-store
      - run:
          name: Lint Frontend
          command: pnpm lint
          working_directory: apps/web
      - run:
          name: Type Check
          command: pnpm type-check
          working_directory: apps/web
      - run:
          name: Stamp build with commit hash
          command: echo "export NEXT_PUBLIC_COMMIT_HASH=$(git rev-parse --short HEAD)" >> $BASH_ENV
      - run:
          name: Build Frontend
          command: pnpm build
          working_directory: apps/web
          environment:
            NEXT_PUBLIC_COMMIT_HASH: ${NEXT_PUBLIC_COMMIT_HASH}
      - persist_to_workspace:
          root: .
          paths:
            - apps/web/.next
            - apps/web/node_modules

  # Deploy frontend to Vercel
  deploy_frontend:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install Vercel CLI
          command: npm install -g vercel
      - run:
          name: Deploy to Vercel
          command: |
            cd apps/web
            vercel pull --yes --environment=production --token=${VERCEL_TOKEN}
            vercel build --prod --token=${VERCEL_TOKEN}
            vercel deploy --prebuilt --prod --token=${VERCEL_TOKEN}

  # Build and test backend
  build_backend:
    docker:
      - image: cimg/python:3.11
    working_directory: ~/project
    steps:
      - checkout
      - restore_cache:
          keys:
            - python-deps-{{ checksum "apps/python/requirements.txt" }}
            - python-deps-
      - run:
          name: Install Dependencies
          command: |
            python -m venv venv
            . venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
          working_directory: apps/python
      - save_cache:
          key: python-deps-{{ checksum "apps/python/requirements.txt" }}
          paths:
            - apps/python/venv
      - run:
          name: Check Python Syntax
          command: |
            . venv/bin/activate
            python -m py_compile *.py
          working_directory: apps/python
      - persist_to_workspace:
          root: .
          paths:
            - apps/python/venv

  # Deploy backend to Render
  deploy_backend:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Trigger Render Deploy
          command: |
            if [ -z "${RENDER_DEPLOY_HOOK_ID}" ]; then
              echo "RENDER_DEPLOY_HOOK_ID not set. Skipping Render deployment."
              exit 0
            fi
            curl -X POST \
              -H "Accept: application/json" \
              -H "Authorization: Bearer ${RENDER_API_KEY}" \
              "https://api.render.com/deploy/${RENDER_DEPLOY_HOOK_ID}"

workflows:
  # Main build and deploy workflow
  build_and_deploy:
    jobs:
      # Validate config first
      - validate_config
      
      # Build both frontend and backend in parallel
      - build_frontend:
          requires:
            - validate_config
      - build_backend:
          requires:
            - validate_config
      
      # Deploy frontend after successful build
      - deploy_frontend:
          requires:
            - build_frontend
          context:
            - deployment-secrets
          filters:
            branches:
              only:
                - main
      
      # Deploy backend after successful build
      - deploy_backend:
          requires:
            - build_backend
          context:
            - deployment-secrets
          filters:
            branches:
              only:
                - main
